<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:CarslineApp.ViewModels"
             xmlns:models="clr-namespace:CarslineApp.Models"
             x:Class="CarslineApp.Views.InventarioPage"
             x:DataType="viewmodels:InventarioViewModel"
             Title="Inventario de Refacciones"
             Shell.NavBarIsVisible="True">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Estilos Modernos -->
            <Style x:Key="CardFrame" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="BorderColor" Value="#E0E0E0"/>
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="HasShadow" Value="True"/>
                <Setter Property="Padding" Value="15"/>
                <Setter Property="Margin" Value="10,8"/>
            </Style>

            <Style x:Key="SearchEntry" TargetType="Entry">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="TextColor" Value="#2C3E50"/>
                <Setter Property="PlaceholderColor" Value="#95A5A6"/>
                <Setter Property="FontSize" Value="15"/>
                <Setter Property="HeightRequest" Value="45"/>
            </Style>

            <Style x:Key="ActionButton" TargetType="Button">
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="WidthRequest" Value="40"/>
                <Setter Property="HeightRequest" Value="40"/>
                <Setter Property="CornerRadius" Value="20"/>
                <Setter Property="Padding" Value="0"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto" BackgroundColor="#F0F2F5">

        <!-- Header con gradiente -->
        <Frame Grid.Row="0"
               BackgroundColor="#3498DB"
               CornerRadius="0"
               Padding="20,30,20,20"
               HasShadow="True"
               Margin="0">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <VerticalStackLayout Grid.Column="0" Spacing="5">
                    <Label Text="ðŸ“¦ Inventario"
                           FontSize="26"
                           FontAttributes="Bold"
                           TextColor="White"/>
                    <Label Text="{Binding CantidadMostrada, StringFormat='Mostrando {0} refacciones'}"
                           FontSize="14"
                           TextColor="White"
                           Opacity="0.9"/>
                </VerticalStackLayout>

                <!-- BotÃ³n Exportar Excel -->
                <Button Grid.Column="1"
                        Text="ðŸ“Š"
                        FontSize="24"
                        BackgroundColor="#27AE60"
                        TextColor="White"
                        WidthRequest="50"
                        HeightRequest="50"
                        CornerRadius="25"
                        Command="{Binding ExportarExcelCommand}"
                        VerticalOptions="Center"
                        Margin="0,0,10,0"/>

                <!-- BotÃ³n Refresh -->
                <Button Grid.Column="2"
                        Text="ðŸ”„"
                        FontSize="24"
                        BackgroundColor="#9B59B6"
                        TextColor="White"
                        WidthRequest="50"
                        HeightRequest="50"
                        CornerRadius="25"
                        Command="{Binding RefreshCommand}"
                        VerticalOptions="Center"/>
            </Grid>
        </Frame>

        <!-- Indicador de carga -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          Color="#3498DB"
                          HeightRequest="40"
                          Margin="0,10,0,0"/>

        <!-- Barra de BÃºsqueda y Filtros -->
        <Frame Grid.Row="2"
               BackgroundColor="White"
               BorderColor="#E0E0E0"
               CornerRadius="15"
               Padding="15"
               Margin="15,10"
               HasShadow="True">
            <VerticalStackLayout Spacing="10">

                <!-- BÃºsqueda por texto -->
                <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                    <Border Grid.Column="0"
                            BackgroundColor="White"
                            Stroke="#BDC3C7"
                            StrokeThickness="1.5"
                            Padding="12,0"
                            StrokeShape="RoundRectangle 10">
                        <Entry Text="{Binding TextoBusqueda}"
                               Placeholder="ðŸ” Buscar por nÃºmero, marca, modelo..."
                               Style="{StaticResource SearchEntry}"
                               ReturnCommand="{Binding BuscarCommand}"/>
                    </Border>

                    <Button Grid.Column="1"
                            Text="ðŸ”"
                            FontSize="20"
                            BackgroundColor="#3498DB"
                            TextColor="White"
                            WidthRequest="45"
                            HeightRequest="45"
                            CornerRadius="10"
                            Command="{Binding BuscarCommand}"/>

                    <Button Grid.Column="2"
                            Text="âœ–ï¸"
                            FontSize="18"
                            BackgroundColor="#95A5A6"
                            TextColor="White"
                            WidthRequest="45"
                            HeightRequest="45"
                            CornerRadius="10"
                            Command="{Binding LimpiarBusquedaCommand}"/>
                </Grid>

                <!-- Filtro por tipo -->
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                    <Label Grid.Column="0"
                           Text="ðŸ·ï¸ Tipo:"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="#34495E"
                           VerticalOptions="Center"/>

                    <Border Grid.Column="1"
                            BackgroundColor="White"
                            Stroke="#BDC3C7"
                            StrokeThickness="1.5"
                            Padding="0"
                            StrokeShape="RoundRectangle 10">
                        <Picker ItemsSource="{Binding TiposFiltro}"
                                SelectedItem="{Binding FiltroTipo}"
                                FontSize="14"
                                TextColor="#2C3E50"
                                BackgroundColor="Transparent"
                                HeightRequest="40"/>
                    </Border>
                </Grid>

            </VerticalStackLayout>
        </Frame>

        <!-- Lista de refacciones con RefreshView -->
        <RefreshView Grid.Row="3"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshCommand}"
                     RefreshColor="#3498DB">
            <ScrollView>
                <StackLayout Padding="10,5">

                    <!-- Mensaje cuando NO hay refacciones -->
                    <Frame IsVisible="{Binding HayRefacciones, Converter={StaticResource InverseBoolConverter}}"
                           BackgroundColor="White"
                           BorderColor="#E0E0E0"
                           CornerRadius="20"
                           Padding="40"
                           Margin="20,60">
                        <VerticalStackLayout HorizontalOptions="Center" 
                                           VerticalOptions="Center"
                                           Spacing="15">
                            <Label Text="ðŸ“¦"
                                   FontSize="80"
                                   HorizontalOptions="Center"/>
                            <Label Text="No se encontraron refacciones"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   TextColor="#7F8C8D"/>
                            <Label Text="Intenta con otra bÃºsqueda o presiona '+' para agregar"
                                   FontSize="14"
                                   HorizontalOptions="Center"
                                   TextColor="#BDC3C7"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Lista de refacciones -->
                    <CollectionView ItemsSource="{Binding RefaccionesFiltradas}"
                                    IsVisible="{Binding HayRefacciones}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RefaccionDto">
                                <Frame Style="{StaticResource CardFrame}">
                                    <Grid RowDefinitions="Auto,Auto,Auto" 
                                          ColumnDefinitions="Auto,*,Auto"
                                          RowSpacing="10"
                                          ColumnSpacing="15">

                                        <!-- Badge de color segÃºn tipo con borde -->
                                        <Border Grid.Row="0" Grid.Column="0"
                                                BackgroundColor="{Binding ColorTipo}"
                                                Stroke="{Binding ColorTipo}"
                                                StrokeThickness="2"
                                                Padding="12"
                                                WidthRequest="55"
                                                HeightRequest="55"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12"/>
                                            </Border.StrokeShape>
                                            <Label Text="{Binding IconoTipo}"
                                                   FontSize="26"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>
                                        </Border>

                                        <!-- NÃºmero de parte y descripciÃ³n -->
                                        <VerticalStackLayout Grid.Row="0" Grid.Column="1" 
                                                           Spacing="5"
                                                           VerticalOptions="Center">
                                            <Label Text="{Binding NumeroParte}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="#1A1A1A"/>
                                            <Label Text="{Binding DescripcionCompleta}"
                                                   FontSize="12"
                                                   TextColor="#5F6368"
                                                   MaxLines="2"/>
                                        </VerticalStackLayout>

                                        <!-- Stock Badge con borde -->
                                        <Border Grid.Row="0" Grid.Column="2"
                                                BackgroundColor="{Binding ColorStockFondo}"
                                                Stroke="{Binding ColorStock}"
                                                StrokeThickness="2"
                                                Padding="12,8"
                                                VerticalOptions="Center"
                                                MinimumWidthRequest="50">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10"/>
                                            </Border.StrokeShape>
                                            <Label Text="{Binding Cantidad}"
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding ColorStock}"
                                                   HorizontalOptions="Center"/>
                                        </Border>

                                        <!-- Separador mÃ¡s visible -->
                                        <BoxView Grid.Row="1" Grid.ColumnSpan="3"
                                                 HeightRequest="1.5"
                                                 BackgroundColor="#D0D0D0"
                                                 Margin="0,5"/>

                                        <!-- Botones de acciÃ³n -->
                                        <Grid Grid.Row="2" Grid.ColumnSpan="3"
                                              ColumnDefinitions="Auto,*,Auto"
                                              ColumnSpacing="10">

                                            <!-- Botones rÃ¡pidos +1 / -1 (Izquierda) -->
                                            <HorizontalStackLayout Grid.Column="0"
                                                                 Spacing="8">
                                                <!-- BotÃ³n +1 RÃ¡pido -->
                                                <Button Text="+1"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       BackgroundColor="#27AE60"
                                                       TextColor="White"
                                                       WidthRequest="45"
                                                       HeightRequest="35"
                                                       CornerRadius="8"
                                                       Padding="0"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=AumentarUnoCommand}"
                                                       CommandParameter="{Binding .}"/>

                                                <!-- BotÃ³n -1 RÃ¡pido -->
                                                <Button Text="-1"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       BackgroundColor="#E67E22"
                                                       TextColor="White"
                                                       WidthRequest="45"
                                                       HeightRequest="35"
                                                       CornerRadius="8"
                                                       Padding="0"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=DisminuirUnoCommand}"
                                                       CommandParameter="{Binding .}"/>
                                            </HorizontalStackLayout>

                                            <!-- Botones avanzados (Derecha) -->
                                            <HorizontalStackLayout Grid.Column="2"
                                                                 Spacing="8"
                                                                 HorizontalOptions="End">

                                                <!-- BotÃ³n Aumentar (mÃºltiple) -->
                                                <Button Text="+"
                                                       Style="{StaticResource ActionButton}"
                                                       BackgroundColor="#27AE60"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=AumentarCommand}"
                                                       CommandParameter="{Binding .}"/>

                                                <!-- BotÃ³n Disminuir (mÃºltiple) -->
                                                <Button Text="âˆ’"
                                                       Style="{StaticResource ActionButton}"
                                                       BackgroundColor="#E67E22"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=DisminuirCommand}"
                                                       CommandParameter="{Binding .}"/>

                                                <!-- BotÃ³n Eliminar -->
                                                <Button Text="ðŸ—‘ï¸"
                                                       Style="{StaticResource ActionButton}"
                                                       BackgroundColor="#E74C3C"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=EliminarCommand}"
                                                       CommandParameter="{Binding .}"/>

                                            </HorizontalStackLayout>
                                        </Grid>

                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </StackLayout>
            </ScrollView>
        </RefreshView>

        <!-- Botones inferiores -->
        <Grid Grid.Row="4" 
              ColumnDefinitions="*,Auto"
              Padding="15"
              ColumnSpacing="10"
              BackgroundColor="White"
              HeightRequest="80">

            <!-- BotÃ³n Agregar -->
            <Button Grid.Column="0"
                   Text="+ Agregar RefacciÃ³n"
                   BackgroundColor="#3498DB"
                   TextColor="White"
                   FontAttributes="Bold"
                   FontSize="16"
                   CornerRadius="12"
                   HeightRequest="50"
                   Command="{Binding AgregarRefaccionCommand}"/>

            <!-- BotÃ³n Volver -->
            <Button Grid.Column="1"
                   Text="Volver"
                   BackgroundColor="#95A5A6"
                   TextColor="White"
                   FontAttributes="Bold"
                   FontSize="16"
                   CornerRadius="12"
                   WidthRequest="100"
                   HeightRequest="50"
                   Command="{Binding VolverCommand}"/>
        </Grid>

    </Grid>
</ContentPage>